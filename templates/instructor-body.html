<section>
    <!-- <pre>|{{ json_encode($provider_details) }}|</pre> -->
    
    {% if ($state == "init") { %}
        <h2 class="tool-header">Conversion Setup</h2>
        <blockquote>Choose how you would like this site converted to Amathuba</blockquote>
        <div class="row">
            <div class="col-md-8">
                <form class="needs-validation form-horizontal"  id="metadata">
                    <input type="hidden" name="state"  id="state" value="{{ $state }}" />
                    <input type="hidden" name="site-title" id="site-title" value="{{ $title }}" />
                    <input type="hidden" name="current_user"  id="current_user" value="{{ $current_email }}" />
            
                    <div class="form-group">
                        <div class="col-md-5">
                            <label>Create a new Amathuba site for teaching</label>
                        </div>
                        <div class="col-md-7">
                            <input id="if_course" type="checkbox" class="overflow-control-input" checked="" />
                        {% if (count($provider_details) == 0) { %}
                            <select class="form-control" name="provider_select" id="provider_select" style="width: 420px" required>
                            {% if ($current_dept == '') { %}
                                <option selected data-type="default" value="">Please select a department</option>
                            {% }
                                foreach ($departments as $el) {
                                    $str = $el[1] ." - ". $el[2];
                                    $selected = ($current_dept == $el[0] ? 'selected' : '');
                                    print "<option value=\"". $el[0] ."\" ". $selected .">". $str ."</option>";
                                }
                            %}
                            </select>
                        {% } else { %}
                            {% if (count($provider_details) == 1) { $el = $provider_details[0]; %}
                                <input type="hidden" name="provider" id="provider"
                                    data-full="{{ $el['full'] }}"
                                    data-dept="{{ $el['dept'] }}"
                                    data-year="{{ $el['year'] }}"
                                    data-period="{{ $el['period'] }}"
                                    data-term="{{ $el['term'] }}"
                                    value="{{ $el['dept'] }}{{ $el['year'] }}{{ $el['no'] }}{{ $el['period'] }}" class="form-control disabled" disabled
                                    style="width: 100%;"/>
                                <span>{{ $el['dept'] }}{{ $el['year'] }}{{ $el['no'] }}{{ $el['period'] }}</span>
                            {% } else { %}
                                <select class="form-control" name="provider" id="provider" style="width: 320px" required>
				   {%
                                        foreach ($provider_details as $el) {
                                            $str = $el['dept'] . $el['year'] . $el['no'] . $el['period'];
                                            $selected = ($current_provider == $str ? 'selected' : '');
                                            print "<option data-dept=\"". $el['dept'] ."\" value=\"". $str ."\" ". $selected.">". $str ."</option>";
                                        }
                                    %}
                                </select>
                            {% } %}
                        {% } %}
                        </div>
                    </div>
                    <div class="form-group" id="course_year">
                        <div class="col-md-5">
                            <label>
                                Year in which this course will be taught on Amathuba 
                                <i class="fas fa-question-circle" title="Subject to Faculty approval."></i>
                            </label>
                        </div>
                        <div class="col-md-7">
                            <select id="year" name="year" class="form-control" style="width: 180px; text-align: center;" required>
                                {%  foreach ($years as $val) { $selected = ($current_term == $val ? 'selected' : ''); %}
                                    <option value="{{$val}}" {{$selected}}>{{$val}}</option>
                                {% } %}
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-md-5">
				<label for="notifications">Email Notifications for conversion updates</label>
                        </div>
                        <div class="col-md-7">
                            <span class="multi-item" value="{{ $current_email }}"> {{ $current_email }}</span>
                            <textarea class="form-control" name="notifications" id="notifications" 
                                placeholder="Additional addresses to notify of this migration">{{ $notifications }}</textarea>
                            <button type="button" id="btn_add_me" style="display:none;">Add Me</button>
                        </div>
                    </div>
	      </div>
	</div>
        <button id="btn_option1" class="btn btn-success" type="button" data-path="a" >Start Conversion </button>
        <small id="info" class="text-info" style="display:none;">This might take a couple of seconds.</small>
        </form>
            
        </div>
    {% } elseif (in_array($state, ['starting','exporting','running', 'queued', 'uploading','importing','updating','completed'])) { %} 
        <input type="hidden" name="provider" id="provider" data-dept="{{$current_dept}}" value="{{$current_provider}}"/>
        <input type="hidden" name="year" id="year" value="{{$current_term}}"/>
        {% if($state != 'completed') { %}    

        <div class="row">
            <h2 class="tool-header">Conversion in progress</h2>

            <ul class="steps">
		<li class="step" data-step="1" id="step1"><span class="hidden-xs">Starting</span></li>
		<li class="step" data-step="2" id="step2"><span class="hidden-xs">Exporting</span></li>
		<li class="step" data-step="3" id="step3"><span class="hidden-xs">Running</span></li>
		<li class="step" data-step="4" id="step4"><span class="hidden-xs">Uploading</span></li>
		<li class="step" data-step="5" id="step5"><span class="hidden-xs">Importing</span></li>
		<li class="step" data-step="6" id="step6"><span class="hidden-xs">Updating</span></li>
            </ul>
   
	    {% if($state == 'queued') { %}
	    
	    <blockquote><img id="running_icon" class="hidden-xs hidden-sm" />
		    <p><span id="state-span">uploading </span>started {{ $last_modified  }}</p>
	    </blockquote>

	    {% }  else { %}
	    <blockquote><img id="running_icon" class="hidden-xs hidden-sm" />
		    <p><span id="state-span">{{ $state }} </span>started {{ $last_modified  }}</p>
	    </blockquote>
            {% } %}
        </div>

	<div class="row">
            <p><br/>This Vula site is being converted to Amathuba, which could take between 10 minutes and 12 hours depending on site content and the number of conversions in progress. When it's done, we'll send you an email confirmation, or you can check back here for updates.</p>
        </div>

	{% }} %}

        {% if( $state == 'completed') { %}
        <div class="row">
	    <h2 class="tool-header">Conversion complete <img id="conversion_completed_icon" /></h2>
	    <br/>
            <div class="col-md-9">
            <div class="row display-flex">
                <div class="col-md-3 col-xs-4 col-sm-3 text-center" >
		    <div id="step-image">
		    {% if ($has_report) { %}
		        <a href="{{ $report_url }}" target="_blank">
                            <img src="./static/img/Read_report.svg" alt="Conversion report" width="50px"/>
            		</a>
		    </div>
                    <div id="step-description">
                        <a href="{{ $report_url }}" class="step_title" target="_blank">Conversion Report </a>
                        <p>Issues which may need your attention.</p>
            	    </div>
	    	    {% } %}
        	</div>
        	<div class="col-md-1 col-xs-12 text-center hidden-sm hidden-xs">
		    {% if($imported_site_id > 0) { %}
		        <i class="fas fa-chevron-circle-right fa-2x text-success chev"></i>
                    {% } %}
		</div>
                <div class="col-md-3 col-xs-4 col-sm-3 text-center" id="step_details">
		    {% if($imported_site_id > 0) { %}
		    <div id="step-image"> 
		        <a href="https://amathuba.uct.ac.za/d2l/home/{{ $imported_site_id}}" target="_blank">
                            <img src="./static/img/View_new_site.svg" alt="Converted Amathuba site" width="75px" />
                        </a>
		    </div>
                    <div id="step-description">
		        <a href="https://amathuba.uct.ac.za/d2l/home/{{ $imported_site_id}}" class="step_title" target="_blank" >Converted reference site </a>
                        <p>A copy of this site on Amathuba.</p>
                    </div>
	      	   {% } %}
            	</div>
            	<div class="col-md-1 col-xs-12 text-center hidden-xs hidden-sm">
                    {% if($target_site_id >  0) { %}
		        <i class="fas fa-chevron-circle-right fa-2x text-success chev"></i>
                    {% } %}
		</div>
            	<div class="col-md-3 col-xs-4 col-sm-4 text-center" id="step_details">
		     {% if($target_site_id > 0 )  { %}
		     <div id="step-image">
		         <a href="https://amathuba.uct.ac.za/d2l/home/{{ $target_site_id}}" target="_blank" >
                             <img src="./static/img/Step 3.svg" alt="New Amathuba site" width="75px" />
                   	 </a>
		    </div>
                    <div id="step-description">
                        <a href="https://amathuba.uct.ac.za/d2l/home/{{ $target_site_id}}" class="step_title" target="_blank" >New Amathuba site </a>
                        <p>Import and update content and activities in this new site.</p>
                    </div>
              	    {% } %}
            	</div>
    	    </div>
	</div>
	<div class="col-md-3 col-xs-12">&nbsp;</div>
    </div>
    <p>This site has been converted to Amathuba! Here's what to do next:</p>
    <ol>
        <li>Read the <a href="{{ $report_url }}" target="_blank">conversion report</a> which provides details on any issues that may need attention.</li>
        <li>Visit the <a href="https://amathuba.uct.ac.za/d2l/home/{{ $imported_site_id}}" target="_blank" >converted reference  site</a> on Amathuba to review how the Vula content has converted to Amathuba tools.</li>
	{% if($target_site_id > 0) { %}
	<li>Build your <a href="https://amathuba.uct.ac.za/d2l/home/{{ $target_site_id}}" target="_blank">new Amathuba site</a> by importing content from the converted reference site as needed.</li>
        {% } else {%}
            <li>Create a new Amathuba site, and import content from the converted reference site as needed.</li>
	{% } %}
        <li>Edit content or update settings in the new site as needed to address any issues flagged in the conversion report.</li>
    </ol>
 </div>
{% } %}

{% if( $state == 'error') { %}
<div class="row">
	<h2 class="tool-header">Conversion failed <img id="conversion_failed_icon"/></h2>
    <p>The conversion of this site to Amathuba ran into an unexpected error. We're looking into it, and will let you know as soon as there's an update</p>
</div>
{% }  %}

<div class="contact-box">
   <div class="icon icon_1"></div>
   <div class="icon icon_2 hidden-xs hidden-sm"></div>
</div>
<div class="row" id="support-footer">
    <div class="col-md-1 hidden-xs hidden-sm">&nbsp;</div>
    <div class="col-md-11" id="support-section">
    <p id="support_text">Need more help or advice? Consult the
            <a href="http://www.cilt.uct.ac.za/cilt/amathuba" title="Amathuba : Support" target="_blank"/>help documentation</a>
             or contact
            <a href="mailto:cilt-helpdesk@uct.ac.za?subject=Amathuba%20Conversion%3A%20{{ htmlentities($title) }}&body=Hi%20Support%20Team%2C%0D%0A%0D%0APlease%20help%20me%20with%20the%20migration%20of%20my%20site%3A%20{{ htmlentities($title) }}%20({{ htmlentities($site_id) }})%0D%0A%0D%0AThanks%20%3A)" title="Send help email">cilt-helpdesk@uct.ac.za</a>.</p>
    </div>
</div>
</div>
</div>
</section>
