{% foreach($scripts as $script): %}
    <script src="{{$script}}" type="text/javascript"></script>
{% endforeach; %}

<script type="text/javascript">
    jQuery.fn.exists = function(){ return this.length > 0; }

    $(function() {
        const progress_interval = 60000;
        let timeout = null,
            progress_timer = null,
            progress_inc = 1;
            progress = 0;

        function setError(st) {
            $(st).removeClass('text-success text-info').addClass('text-danger').children('i').removeClass('fa-ellipsis-h fa-check').addClass('fa-times');
            $(st).delay(10000).queue(function(){
                $(this).removeClass('text-success text-info text-danger').children('i').removeClass('fa-ellipsis-h fa-check fa-times');
            });
        }

        function setSaved(st) {
            $(st).removeClass('text-success text-info').addClass('text-success').children('i').removeClass('fa-ellipsis-h fa-times').addClass('fa-check');
            $(st).delay(10000).queue(function(){
                $(this).removeClass('text-success text-info text-danger').children('i').removeClass('fa-ellipsis-h fa-check fa-times');
            });
        }

        function setSaving(st) {
            $(st).removeClass('text-success text-danger').addClass('text-info').children('i').removeClass('fa-times fa-check').addClass('fa-ellipsis-h');
        }

        function hideHelp() {
            clearTimeout(timeout);
            $('#info').hide();
        }

        function showError(a) {
            $('#' + a).html('<i class="fa fa-exclamation"></i> Error').addClass('disabled').attr('disabled', true);
            $('#message').html('<p class="bg-danger">An error occurred while performing this action, please contact <a href="mailto:help@vula.uct.ac.za?subject=Vula - Please help with: Lecture Recording Setup">help@vula.uct.ac.za</a><br/> or call 021-650-5500 weekdays 8:30 - 17:00.</p>');
        }

        function submit_sites(sites, a, text) {
            
            if (sites.length > 0) {
                $('#' + a).html('<i class="fa fa-cog fa-spin"></i>' + text).addClass('disabled').attr('disabled', true);
                timeout = setTimeout(function(){ $('#info').show(); }, 300);

                var jqxhr = $.post('{{ $submit }}', { "type": 'add_sites', "sites": sites }, function(result) {
                    hideHelp();
                    if (result.success === 1) {
                        $('#' + a).html('<i class="fa fa-check"></i> Refreshing page ...');
                        setTimeout(function() { location.reload(); }, 300);
                    } else {
                        showError(a);
                    }
                }, 'json')
                .fail(function() {
                    hideHelp();
                    showError(a);
                })
                .always(function() {
                    hideHelp();
                });
            }
        }

        function doPost(a, text) {
            submit_sites( $('#add_sites').val().split(/\r?\n/g).filter( (x) => { return x.length  > 2 }), a, text);
        }

        function getworkflow(site) {
            var jqxhr = $.getJSON('{{ $fetch_workflow }}', {'type' : 'workflow', 'site' : site }, function(result) {
                const _pre = $('#pre');

                if (result.success === 1) {
                    _pre.html(result.msg.join("<br/>"));
                    setProgress(true);
                } else {
                    _pre.html("Could not load workflow for site.");
                }
            })
            .fail(function() {
                $('#pre').html("Could not load workflow for site.");
            });
        }

        function doTimer () {
            const _container = $('.progress-container');
            progress += progress_inc;

            _container.children('.progress').width((progress / _container.width() * 100) + '%');

            if (progress >= _container.width()) {
                window.clearInterval(progress_timer);
                // time to reload selected pre
                if ($('#sites .active a').exists()) {
                    const _me = $('#sites .active a'),
                          _pre = $('#pre');
                    
                    _pre.html("Loading ("+ (_me.data('title') ? _me.data('title') +" : " : "" ) + _me.attr('rel') +") ...");
                    getworkflow(_me.attr('rel'));
                }
            }
        }

        function setProgress(run) {
            const _container = $('.progress-container'),
                  _autoreload = $('#autoreload').is(':checked');
            progress = 0;
            progress_inc = _container.width() / 100 / 2;
            _container.children('.progress').width((progress / _container.width() * 100) + '%');
            
            window.clearInterval(progress_timer);
            if (run && _autoreload) {
                progress_timer = window.setInterval(doTimer, progress_interval / 600);
            }
        }

        $('#autoreload').click(function(event) {
            const _autoreload = $('#autoreload').is(':checked');
            if (_autoreload && $('#sites .active a').exists()) {
                setProgress(true);
            } else {
                setProgress(false);
            }
        });

        $('#btnAccept').click(function(event) {
            event.preventDefault();
            doPost('btnAccept', 'Adding sites ...');
        });

        $('#sites').on('click', 'a.site', function(event) {
            event.preventDefault();
            const _me = $(this),
                  _pre = $('#pre');

            if (!_me.parent().hasClass('active')) {
                _me.parent().siblings().removeClass('active');
                _me.parent().addClass('active');

                _pre.html("Loading ("+ (_me.data('title') ? _me.data('title') +" : " : "" ) + _me.attr('rel') +") ...");
                getworkflow(_me.attr('rel'));
            }
        });
        
        $('#sites').on('click', 'a.reload', function(event) {
            event.preventDefault();
            const _me = $(this);

            submit_sites([_me.attr('rel')], 'btnAccept', 'Adding sites ...');
        });

        $('#sites').on('click', 'a.delete', function(event) {
            event.preventDefault();
            const _me = $(this),
                  _title = _me.data('title') === '' ? _me.attr('rel') : _me.data('title');

            if (confirm(`Do you want to delete ${_title}?`) == true) {

                var jqxhr = $.post('{{ $submit }}', { "type": 'delete', "site": _me.attr('rel') }, function(result) {
                    if (result.success === 1) {
                        location.reload();
                    } else {
                        alert('Error removing: ' + _title);
                    }
                }, 'json')
                .fail(function() {
                    alert('Error removing: ' + _title);
                })
                .always(function() {
                    hideHelp();
                });
            }
        });        

        $('#btn_reload_progress').on('click', function(event) {
            event.preventDefault();
            location.reload();
        });

        $('#stats > li > a').on('click', function(event) {
            event.preventDefault();
            const _me = $(this),
                  _sites = $('#sites'),
                  _pre = $('#pre');
            
            if (!_me.parent().hasClass('active')) {
                _me.parent().siblings().removeClass('active');
                _me.parent().addClass('active');
                
                _sites.children().removeClass('active');
                _pre.html('');
                if (_me.attr('rel') == 'all') {
                    _sites.children().show();
                } else {
                    _sites.children().hide();
                    _sites.children('[data-state="'+_me.attr('rel')+'"]').show();
                }
                setProgress(false);
            }
        });
        // 'all' => count($sites), 'init' => 0,'starting' => 0,'exporting' => 0,'running' => 0,'importing' => 0,'completed' => 0,'error' => 0
    });
</script>